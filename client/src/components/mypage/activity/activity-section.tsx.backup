import { Heart, Gift, Star, Clock } from 'lucide-react';
import { useLocation } from 'wouter';
import { useState, useEffect } from 'react';
import { useAuth } from '@/hooks/use-auth';
import { useToast } from '@/hooks/use-toast';
import { collection, query, where, getDocs, orderBy } from 'firebase/firestore';
import { db } from '@/lib/firebase';
import ReviewWrite from '@/components/mypage/review/review-write';

interface WishItem {
  id: string;
  userId: string;
  productId: string;
  productName: string;
  productPrice: number;
  productImage?: string;
  createdAt: any;
}

interface Review {
  id: string;
  userId: string;
  productId: string;
  productName: string;
  rating: number;
  content: string;
  createdAt: any;
  updatedAt?: any;
  isEdited?: boolean;
}

interface Coupon {
  id: string;
  userId: string;
  title: string;
  discount: number;
  expiryDate: any;
  isUsed: boolean;
}

const ActivitySection = () => {
  const [, setLocation] = useLocation();
  const { user } = useAuth();
  const { toast } = useToast();
  const [wishItems, setWishItems] = useState<WishItem[]>([]);
  const [reviews, setReviews] = useState<Review[]>([]);
  const [coupons, setCoupons] = useState<Coupon[]>([]);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState<'wishlist' | 'reviews' | 'coupons'>('wishlist');
  const [editingReview, setEditingReview] = useState<string | null>(null);
  const [editContent, setEditContent] = useState('');
  const [editRating, setEditRating] = useState(5);
  const [showWriteReviewGuide, setShowWriteReviewGuide] = useState(false);
  const [showWriteReviewForm, setShowWriteReviewForm] = useState(false);
  const [writeReviewData, setWriteReviewData] = useState<{orderId: string, productName: string} | null>(null);

  // URL íŒŒë¼ë¯¸í„° í™•ì¸í•´ì„œ íƒ­ ì„¤ì •
  useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const tab = urlParams.get('tab');
    const write = urlParams.get('write');

    if (tab === 'reviews') {
      setActiveTab('reviews');
      if (write === 'true') {
        // URLì—ì„œ ì£¼ë¬¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const orderId = urlParams.get('orderId') || 'test-order-1';
        const productName = urlParams.get('productName') || 'í¬ë£¨ì•„ìƒ';

        setWriteReviewData({ orderId, productName });
        setShowWriteReviewForm(true);
      }
    }
  }, []);

  // Firebaseì—ì„œ í™œë™ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  useEffect(() => {
    const fetchActivityData = async () => {
      if (!user?.uid) {
        setLoading(false);
        return;
      }

      try {
        console.log('ğŸ” í™œë™ ë°ì´í„° ì¡°íšŒ ì‹œì‘:', user.uid);

        // ì‹¤ì œ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¶”ê°€
        const testWishItems: WishItem[] = [
          {
            id: 'wish-1',
            userId: user.uid,
            productId: 'bread-1',
            productName: 'í¬ë£¨ì•„ìƒ',
            productPrice: 12500,
            productImage: '/images/croissant.jpg',
            createdAt: { toDate: () => new Date('2024-01-20') }
          },
          {
            id: 'wish-2',
            userId: user.uid,
            productId: 'bread-2',
            productName: 'ë°”ê²ŒíŠ¸',
            productPrice: 18000,
            productImage: '/images/baguette.jpg',
            createdAt: { toDate: () => new Date('2024-01-18') }
          }
        ];

        const testReviews: Review[] = [
          {
            id: 'review-1',
            userId: user.uid,
            productId: 'bread-1',
            productName: 'í¬ë£¨ì•„ìƒ',
            rating: 5,
            content: 'ì •ë§ ë§›ìˆì–´ìš”! ë‹¤ìŒì—ë„ ì£¼ë¬¸í• ê²Œìš”.',
            createdAt: { toDate: () => new Date('2024-01-16') },
            isEdited: false
          },
          {
            id: 'review-2',
            userId: user.uid,
            productId: 'bread-2',
            productName: 'ë°”ê²ŒíŠ¸',
            rating: 4,
            content: 'ë°”ì‚­í•˜ê³  ì¢‹ë„¤ìš”. ì¡°ê¸ˆ ë” ë”°ëœ»í–ˆìœ¼ë©´ ì™„ë²½í–ˆì„ ê²ƒ ê°™ì•„ìš”.',
            createdAt: { toDate: () => new Date('2024-01-12') },
            isEdited: false
          }
        ];

        const testCoupons: Coupon[] = [
          {
            id: 'coupon-1',
            userId: user.uid,
            title: 'ì‹ ê·œ íšŒì› 10% í• ì¸',
            discount: 10,
            expiryDate: { toDate: () => new Date('2024-02-15') },
            isUsed: false
          },
          {
            id: 'coupon-2',
            userId: user.uid,
            title: 'ìƒì¼ ì¶•í•˜ 20% í• ì¸',
            discount: 20,
            expiryDate: { toDate: () => new Date('2024-03-01') },
            isUsed: false
          }
        ];

        console.log('ğŸ§ª í…ŒìŠ¤íŠ¸ í™œë™ ë°ì´í„° ì¶”ê°€');
        setWishItems(testWishItems);
        setReviews(testReviews);
        setCoupons(testCoupons);
      } catch (error) {
        console.error('âŒ í™œë™ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchActivityData();
  }, [user?.uid]);

  // í†µê³„ ê³„ì‚°
  const wishCount = wishItems.length;
  const reviewCount = reviews.length;
  const couponCount = coupons.filter(coupon => !coupon.isUsed).length;
  const lastActivityDays = wishItems.length > 0 ?
    Math.floor((new Date().getTime() - wishItems[0].createdAt.toDate().getTime()) / (1000 * 60 * 60 * 24)) : 0;

  const handleGoToProducts = () => {
    console.log('â¤ï¸ ìƒí’ˆ ë‘˜ëŸ¬ë³´ê¸° í´ë¦­!');
    setLocation('/products');
  };

  const handleShowWishlist = () => {
    console.log('â¤ï¸ ì°œí•œ ìƒí’ˆ ë³´ê¸° í´ë¦­!');
    setActiveTab('wishlist');
  };

  const handleShowReviews = () => {
    console.log('â­ ì‘ì„±í•œ ë¦¬ë·° ë³´ê¸° í´ë¦­!');
    setActiveTab('reviews');
  };

  const handleShowCoupons = () => {
    console.log('ğŸ ë³´ìœ  ì¿ í° ë³´ê¸° í´ë¦­!');
    setActiveTab('coupons');
  };

  const handleProductClick = (productId: string, productName: string) => {
    console.log(`ğŸ” ì°œí•œ ìƒí’ˆ í´ë¦­: ${productName} (${productId})`);
    setLocation(`/products/${productId}`); // ìƒí’ˆ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
  };

  const handleAddToCart = (item: WishItem, event: React.MouseEvent) => {
    event.stopPropagation(); // ìƒí’ˆ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
    console.log(`ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°: ${item.productName}`);

    // ì‹¤ì œ ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ ë¡œì§ (ì˜ˆì‹œ)
    const cartItem = {
      productId: item.productId,
      productName: item.productName,
      price: item.productPrice,
      quantity: 1,
      image: item.productImage
    };

    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë‚˜ ìƒíƒœ ê´€ë¦¬ë¡œ ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€
    const existingCart = JSON.parse(localStorage.getItem('cart') || '[]');
    const existingItemIndex = existingCart.findIndex((cartItem: any) => cartItem.productId === item.productId);

    if (existingItemIndex >= 0) {
      existingCart[existingItemIndex].quantity += 1;
    } else {
      existingCart.push(cartItem);
    }

    localStorage.setItem('cart', JSON.stringify(existingCart));

    // ì„¸ë ¨ëœ í† ìŠ¤íŠ¸ ì•Œë¦¼
    toast({
      title: "ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ›’",
      description: `${item.productName}ì„(ë¥¼) ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•˜ìŠµë‹ˆë‹¤.`,
      variant: "default",
    });
  };

  const handleRemoveFromWishlist = (itemId: string, productName: string, event: React.MouseEvent) => {
    event.stopPropagation(); // ìƒí’ˆ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
    console.log(`ğŸ’” ì°œ í•´ì œ: ${productName}`);

    // ì°œ ëª©ë¡ì—ì„œ ì œê±°
    setWishItems(prev => prev.filter(item => item.id !== itemId));

    // ì„¸ë ¨ëœ í† ìŠ¤íŠ¸ ì•Œë¦¼
    toast({
      title: "ì°œ ëª©ë¡ì—ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ’”",
      description: `${productName}ì„(ë¥¼) ì°œ ëª©ë¡ì—ì„œ ì œê±°í–ˆìŠµë‹ˆë‹¤.`,
      variant: "destructive",
    });
  };

  // ë¦¬ë·° ìˆ˜ì • ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸ (êµ¬ë§¤ ì™„ë£Œ í›„ 14ì¼ ì´ë‚´)
  const canEditReview = (review: Review) => {
    const daysSinceCreated = Math.floor(
      (new Date().getTime() - review.createdAt.toDate().getTime()) / (1000 * 60 * 60 * 24)
    );
    return daysSinceCreated <= 14;
  };

  // ë¦¬ë·° ìˆ˜ì • ì‹œì‘
  const handleEditReview = (review: Review) => {
    setEditingReview(review.id);
    setEditContent(review.content);
    setEditRating(review.rating);
  };

  // ë¦¬ë·° ìˆ˜ì • ì €ì¥
  const handleSaveReview = (reviewId: string) => {
    setReviews(prev => prev.map(review =>
      review.id === reviewId
        ? {
            ...review,
            content: editContent,
            rating: editRating,
            updatedAt: { toDate: () => new Date() },
            isEdited: true
          }
        : review
    ));

    setEditingReview(null);
    setEditContent('');
    setEditRating(5);

    toast({
      title: "ë¦¬ë·°ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! âœï¸",
      description: "ë¦¬ë·° ë‚´ìš©ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.",
      variant: "default",
    });
  };

  // ë¦¬ë·° ìˆ˜ì • ì·¨ì†Œ
  const handleCancelEdit = () => {
    setEditingReview(null);
    setEditContent('');
    setEditRating(5);
  };

  // ìƒˆ ë¦¬ë·° ì €ì¥ ì™„ë£Œ ì²˜ë¦¬
  const handleReviewSaved = (newReview: Review) => {
    console.log('ğŸ‰ handleReviewSaved í˜¸ì¶œë¨!');
    console.log('ğŸ“ ìƒˆ ë¦¬ë·° ì¶”ê°€:', newReview);

    // ë¦¬ë·° ëª©ë¡ì— ìƒˆ ë¦¬ë·° ì¶”ê°€
    setReviews(prev => [newReview, ...prev]);

    // localStorageì— ë¦¬ë·° ì™„ë£Œ ìƒíƒœ ì €ì¥ (ì „ì—­ ìƒíƒœ ê´€ë¦¬)
    if (newReview.orderId) {
      console.log('ğŸ’¾ localStorageì— ë¦¬ë·° ì™„ë£Œ ìƒíƒœ ì €ì¥:', newReview.orderId);

      // ê¸°ì¡´ ì™„ë£Œëœ ë¦¬ë·° ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
      const completedReviews = JSON.parse(localStorage.getItem('completedReviews') || '[]');

      // ìƒˆ ë¦¬ë·° ì¶”ê°€
      if (!completedReviews.includes(newReview.orderId)) {
        completedReviews.push(newReview.orderId);
        localStorage.setItem('completedReviews', JSON.stringify(completedReviews));
        console.log('âœ… ë¦¬ë·° ì™„ë£Œ ìƒíƒœ ì €ì¥ ì™„ë£Œ:', completedReviews);
      }
    }

    // ë¦¬ë·° ì‘ì„± í¼ ë‹«ê¸°
    setShowWriteReviewForm(false);
    setWriteReviewData(null);
    console.log('ğŸ”š ë¦¬ë·° ì‘ì„± í¼ ë‹«ê¸° ì™„ë£Œ');
  };

  return (
    <div className="space-y-6">
      {/* í—¤ë” */}
      <div className="flex items-center gap-3">
        <Heart className="w-8 h-8 text-[#EC4899]" />
        <h2 className="text-2xl font-bold text-white">MY í™œë™</h2>
      </div>

      {/* í´ë¦­ ê°€ëŠ¥í•œ í™œë™ í†µê³„ ì¹´ë“œ */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        {/* ì°œí•œ ìƒí’ˆ */}
        <button
          onClick={handleShowWishlist}
          className="bg-[#1A1A1A] border border-[#333] rounded-lg p-6 text-left hover:border-[#EC4899] hover:bg-[#1A1A1A]/80 transition-all cursor-pointer group"
        >
          <div className="flex items-center gap-3 mb-2">
            <Heart className="w-5 h-5 text-[#EC4899] group-hover:scale-110 transition-transform" />
            <div className="text-sm text-gray-400 group-hover:text-white">ì°œí•œ ìƒí’ˆ</div>
          </div>
          <div className="text-2xl font-bold text-white">{loading ? '...' : `${wishCount}ê°œ`}</div>
          <div className="text-xs text-[#EC4899] mt-1 opacity-0 group-hover:opacity-100 transition-opacity">
            í´ë¦­í•˜ì—¬ ì°œí•œ ìƒí’ˆ ë³´ê¸° â†’
          </div>
        </button>

        {/* ì‘ì„±í•œ ë¦¬ë·° */}
        <button
          onClick={handleShowReviews}
          className="bg-[#1A1A1A] border border-[#333] rounded-lg p-6 text-left hover:border-[#F59E0B] hover:bg-[#1A1A1A]/80 transition-all cursor-pointer group"
        >
          <div className="flex items-center gap-3 mb-2">
            <Star className="w-5 h-5 text-[#F59E0B] group-hover:scale-110 transition-transform" />
            <div className="text-sm text-gray-400 group-hover:text-white">ì‘ì„±í•œ ë¦¬ë·°</div>
          </div>
          <div className="text-2xl font-bold text-white">{loading ? '...' : `${reviewCount}ê°œ`}</div>
          <div className="text-xs text-[#F59E0B] mt-1 opacity-0 group-hover:opacity-100 transition-opacity">
            í´ë¦­í•˜ì—¬ ì‘ì„±í•œ ë¦¬ë·° ë³´ê¸° â†’
          </div>
        </button>

        {/* ë³´ìœ  ì¿ í° */}
        <button
          onClick={handleShowCoupons}
          className="bg-[#1A1A1A] border border-[#333] rounded-lg p-6 text-left hover:border-[#10B981] hover:bg-[#1A1A1A]/80 transition-all cursor-pointer group"
        >
          <div className="flex items-center gap-3 mb-2">
            <Gift className="w-5 h-5 text-[#10B981] group-hover:scale-110 transition-transform" />
            <div className="text-sm text-gray-400 group-hover:text-white">ë³´ìœ  ì¿ í°</div>
          </div>
          <div className="text-2xl font-bold text-white">{loading ? '...' : `${couponCount}ì¥`}</div>
          <div className="text-xs text-[#10B981] mt-1 opacity-0 group-hover:opacity-100 transition-opacity">
            í´ë¦­í•˜ì—¬ ë³´ìœ  ì¿ í° ë³´ê¸° â†’
          </div>
        </button>

        {/* ìµœê·¼ í™œë™ */}
        <div className="bg-[#1A1A1A] border border-[#333] rounded-lg p-6">
          <div className="flex items-center gap-3 mb-2">
            <Clock className="w-5 h-5 text-[#A78BFA]" />
            <div className="text-sm text-gray-400">ìµœê·¼ í™œë™</div>
          </div>
          <div className="text-2xl font-bold text-white">{loading ? '...' : `${lastActivityDays}ì¼ ì „`}</div>
          <div className="text-xs text-gray-500 mt-1">
            ë§ˆì§€ë§‰ ì°œí•œ ë‚ ì§œ ê¸°ì¤€
          </div>
        </div>
      </div>

      {/* íƒ­ ë©”ë‰´ */}
      <div className="flex gap-2 border-b border-[#333]">
        <button
          onClick={() => setActiveTab('wishlist')}
          className={`px-4 py-2 font-medium transition-colors ${
            activeTab === 'wishlist'
              ? 'text-[#EC4899] border-b-2 border-[#EC4899]'
              : 'text-gray-400 hover:text-white'
          }`}
        >
          ì°œí•œ ìƒí’ˆ
        </button>
        <button
          onClick={() => setActiveTab('reviews')}
          className={`px-4 py-2 font-medium transition-colors ${
            activeTab === 'reviews'
              ? 'text-[#F59E0B] border-b-2 border-[#F59E0B]'
              : 'text-gray-400 hover:text-white'
          }`}
        >
          ì‘ì„±í•œ ë¦¬ë·°
        </button>
        <button
          onClick={() => setActiveTab('coupons')}
          className={`px-4 py-2 font-medium transition-colors ${
            activeTab === 'coupons'
              ? 'text-[#10B981] border-b-2 border-[#10B981]'
              : 'text-gray-400 hover:text-white'
          }`}
        >
          ë³´ìœ  ì¿ í°
        </button>
      </div>

      {/* íƒ­ ì»¨í…ì¸  */}
      {loading ? (
        <div className="bg-[#1A1A1A] border border-[#333] rounded-lg p-12 text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#EC4899] mx-auto mb-4"></div>
          <p className="text-gray-400">í™œë™ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
      ) : (
        <div className="bg-[#1A1A1A] border border-[#333] rounded-lg p-6">
          {/* ì°œí•œ ìƒí’ˆ íƒ­ */}
          {activeTab === 'wishlist' && (
            <>
              {wishItems.length === 0 ? (
                <div className="text-center py-8">
                  <Heart className="w-16 h-16 text-gray-600 mx-auto mb-4" />
                  <h3 className="text-xl font-semibold text-white mb-2">ì°œí•œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</h3>
                  <p className="text-gray-400 mb-6">
                    ë§ˆìŒì— ë“œëŠ” ìƒí’ˆì„ ì°œí•´ë³´ì„¸ìš”!<br />
                    ì°œí•œ ìƒí’ˆì€ ì—¬ê¸°ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                  </p>
                  <button
                    onClick={handleGoToProducts}
                    className="bg-[#EC4899] hover:bg-[#DB2777] text-white px-6 py-3 rounded-lg font-medium transition-colors"
                  >
                    ìƒí’ˆ ë‘˜ëŸ¬ë³´ê¸°
                  </button>
                </div>
              ) : (
                <div className="space-y-4">
                  <div className="flex items-center justify-between mb-6">
                    <h3 className="text-lg font-semibold text-white">ì°œí•œ ìƒí’ˆ ({wishItems.length}ê°œ)</h3>
                    <p className="text-sm text-gray-400">ìƒí’ˆì„ í´ë¦­í•˜ë©´ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤</p>
                  </div>

                  {wishItems.map(item => (
                    <div
                      key={item.id}
                      onClick={() => handleProductClick(item.productId, item.productName)}
                      className="bg-[#0A0A0A] border border-[#333] rounded-lg p-6 hover:border-[#EC4899] hover:bg-[#111] transition-all cursor-pointer group"
                    >
                      <div className="flex items-center gap-6">
                        {/* ìƒí’ˆ ì´ë¯¸ì§€ */}
                        <div className="w-20 h-20 bg-gradient-to-br from-[#222] to-[#333] rounded-xl flex items-center justify-center shadow-lg group-hover:shadow-[#EC4899]/20 transition-all">
                          {item.productImage ? (
                            <img
                              src={item.productImage}
                              alt={item.productName}
                              className="w-full h-full object-cover rounded-xl"
                            />
                          ) : (
                            <Heart className="w-10 h-10 text-[#EC4899] group-hover:scale-110 transition-transform" />
                          )}
                        </div>

                        {/* ìƒí’ˆ ì •ë³´ */}
                        <div className="flex-1">
                          <h4 className="font-bold text-white text-lg group-hover:text-[#EC4899] transition-colors mb-1">
                            {item.productName}
                          </h4>
                          <div className="flex items-center gap-2 mb-2">
                            <div className="w-1.5 h-1.5 bg-[#EC4899] rounded-full"></div>
                            <p className="text-gray-400 text-sm">
                              ì°œí•œ ë‚ ì§œ: {item.createdAt?.toDate?.()?.toLocaleDateString()}
                            </p>
                          </div>
                          <p className="text-xs text-gray-500 group-hover:text-gray-400 transition-colors">
                            í´ë¦­í•˜ì—¬ ìƒí’ˆ ìƒì„¸ë³´ê¸° â†’
                          </p>
                        </div>

                        {/* ê°€ê²© ë° ì•¡ì…˜ ë²„íŠ¼ */}
                        <div className="text-right">
                          <p className="font-bold text-2xl bg-gradient-to-r from-[#EC4899] to-[#F97316] bg-clip-text text-transparent mb-3">
                            {item.productPrice.toLocaleString()}ì›
                          </p>

                          <div className="flex flex-col gap-2">
                            {/* ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° ë²„íŠ¼ */}
                            <button
                              onClick={(e) => handleAddToCart(item, e)}
                              className="bg-gradient-to-r from-[#EC4899] to-[#F97316] hover:from-[#DB2777] hover:to-[#EA580C] text-white px-4 py-2 rounded-lg font-medium transition-all transform hover:scale-105 shadow-lg hover:shadow-[#EC4899]/30"
                            >
                              ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°
                            </button>

                            {/* ì°œ í•´ì œ ë²„íŠ¼ */}
                            <button
                              onClick={(e) => handleRemoveFromWishlist(item.id, item.productName, e)}
                              className="bg-gray-600 hover:bg-red-600 text-white px-4 py-1.5 rounded-lg text-sm font-medium transition-all"
                            >
                              ğŸ’” ì°œ í•´ì œ
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}

                  {/* í•˜ë‹¨ ì•¡ì…˜ ë²„íŠ¼ */}
                  <div className="mt-8 pt-6 border-t border-[#333]">
                    <div className="flex gap-4 justify-center">
                      <button
                        onClick={handleGoToProducts}
                        className="bg-gradient-to-r from-[#A78BFA] to-[#EC4899] hover:from-[#9333EA] hover:to-[#DB2777] text-white px-8 py-3 rounded-xl font-medium transition-all transform hover:scale-105 shadow-lg"
                      >
                        ğŸ” ìƒí’ˆ ë‹¤ì‹œ ë‘˜ëŸ¬ë³´ê¸°
                      </button>
                      <button
                        onClick={() => setLocation('/cart')}
                        className="bg-gradient-to-r from-[#10B981] to-[#059669] hover:from-[#059669] hover:to-[#047857] text-white px-8 py-3 rounded-xl font-medium transition-all transform hover:scale-105 shadow-lg"
                      >
                        ğŸ›’ ì¥ë°”êµ¬ë‹ˆ í™•ì¸í•˜ê¸°
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </>
          )}

          {/* ì‘ì„±í•œ ë¦¬ë·° íƒ­ */}
          {activeTab === 'reviews' && (
            <>
              {/* ë¦¬ë·° ì‘ì„± í¼ */}
              {showWriteReviewForm && writeReviewData && (
                <ReviewWrite
                  orderId={writeReviewData.orderId}
                  productName={writeReviewData.productName}
                  onClose={() => {
                    setShowWriteReviewForm(false);
                    setWriteReviewData(null);
                  }}
                  onReviewSaved={handleReviewSaved}
                />
              )}

              {/* ê¸°ì¡´ ë¦¬ë·° ëª©ë¡ (ì‘ì„± í¼ì´ ì—†ì„ ë•Œë§Œ í‘œì‹œ) */}
              {!showWriteReviewForm && (
                <>
                  {/* ë¦¬ë·° ì‘ì„± ê°€ì´ë“œ */}
                  {showWriteReviewGuide && (
                <div className="bg-gradient-to-r from-[#F59E0B]/20 to-[#D97706]/20 border border-[#F59E0B]/50 rounded-xl p-6 mb-6">
                  <div className="flex items-center gap-3 mb-3">
                    <div className="w-8 h-8 bg-gradient-to-r from-[#F59E0B] to-[#D97706] rounded-full flex items-center justify-center">
                      <span className="text-white text-sm">ğŸ“</span>
                    </div>
                    <h3 className="text-lg font-bold text-white">ë¦¬ë·° ì‘ì„± ì•ˆë‚´</h3>
                    <button
                      onClick={() => setShowWriteReviewGuide(false)}
                      className="ml-auto text-gray-400 hover:text-white transition-colors"
                    >
                      âœ•
                    </button>
                  </div>
                  <p className="text-gray-300 mb-2">
                    <strong className="text-[#F59E0B]">êµ¬ë§¤ì™„ë£Œëœ ìƒí’ˆì— ëŒ€í•œ ë¦¬ë·°ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!</strong>
                  </p>
                  <p className="text-gray-400 text-sm">
                    â€¢ MY ì‡¼í•‘ì—ì„œ êµ¬ë§¤ì™„ë£Œëœ ì£¼ë¬¸ì˜ "ë¦¬ë·° ì‘ì„±" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”<br />
                    â€¢ ë¦¬ë·°ëŠ” ì–¸ì œë“ ì§€ ì‘ì„± ê°€ëŠ¥í•˜ë©°, ì‘ì„± í›„ 14ì¼ ì´ë‚´ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤
                  </p>
                </div>
              )}

              {reviews.length === 0 ? (
                <div className="text-center py-8">
                  <Star className="w-16 h-16 text-gray-600 mx-auto mb-4" />
                  <h3 className="text-xl font-semibold text-white mb-2">ì‘ì„±í•œ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                  <p className="text-gray-400 mb-6">
                    êµ¬ë§¤í•œ ìƒí’ˆì— ëŒ€í•œ ë¦¬ë·°ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!<br />
                    ë‹¤ë¥¸ ê³ ê°ë“¤ì—ê²Œ ë„ì›€ì´ ë©ë‹ˆë‹¤.
                  </p>
                  <button
                    onClick={handleGoToProducts}
                    className="bg-[#F59E0B] hover:bg-[#D97706] text-white px-6 py-3 rounded-lg font-medium transition-colors"
                  >
                    ìƒí’ˆ ë‘˜ëŸ¬ë³´ê¸°
                  </button>
                </div>
              ) : (
                <div className="space-y-4">
                  <div className="flex items-center justify-between mb-6">
                    <h3 className="text-lg font-semibold text-white">ì‘ì„±í•œ ë¦¬ë·° ({reviews.length}ê°œ)</h3>
                    <p className="text-sm text-gray-400">êµ¬ë§¤ ì™„ë£Œ í›„ 14ì¼ ì´ë‚´ ìˆ˜ì • ê°€ëŠ¥</p>
                  </div>

                  {reviews.map(review => (
                    <div key={review.id} className="bg-[#0A0A0A] border border-[#333] rounded-lg p-6 hover:border-[#F59E0B] transition-colors">
                      {editingReview === review.id ? (
                        // ìˆ˜ì • ëª¨ë“œ
                        <div className="space-y-4">
                          <div className="flex items-center gap-4 mb-4">
                            <span className="text-white font-medium">{review.productName}</span>
                            <div className="flex items-center gap-1">
                              {[...Array(5)].map((_, i) => (
                                <Star
                                  key={i}
                                  onClick={() => setEditRating(i + 1)}
                                  className={`w-5 h-5 cursor-pointer transition-colors ${
                                    i < editRating ? 'text-[#F59E0B] fill-current' : 'text-gray-600 hover:text-[#F59E0B]'
                                  }`}
                                />
                              ))}
                            </div>
                          </div>

                          <textarea
                            value={editContent}
                            onChange={(e) => setEditContent(e.target.value)}
                            className="w-full p-4 bg-[#111] border border-[#333] rounded-lg text-white resize-none focus:border-[#F59E0B] focus:ring-2 focus:ring-[#F59E0B]/20"
                            rows={4}
                            placeholder="ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."
                          />

                          <div className="flex gap-3 justify-end">
                            <button
                              onClick={handleCancelEdit}
                              className="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-medium transition-colors"
                            >
                              ì·¨ì†Œ
                            </button>
                            <button
                              onClick={() => handleSaveReview(review.id)}
                              className="px-4 py-2 bg-[#F59E0B] hover:bg-[#D97706] text-white rounded-lg font-medium transition-colors"
                            >
                              ì €ì¥
                            </button>
                          </div>
                        </div>
                      ) : (
                        // ì¼ë°˜ ëª¨ë“œ
                        <div>
                          <div className="flex items-start justify-between mb-4">
                            <div className="flex-1">
                              <div className="flex items-center gap-3 mb-2">
                                <span className="text-white font-medium">{review.productName}</span>
                                <div className="flex items-center gap-1">
                                  {[...Array(5)].map((_, i) => (
                                    <Star
                                      key={i}
                                      className={`w-4 h-4 ${i < review.rating ? 'text-[#F59E0B] fill-current' : 'text-gray-600'}`}
                                    />
                                  ))}
                                </div>
                                {review.isEdited && (
                                  <span className="text-xs text-gray-500 bg-gray-700 px-2 py-1 rounded">ìˆ˜ì •ë¨</span>
                                )}
                              </div>
                              <p className="text-white mb-3 leading-relaxed">{review.content}</p>
                              <div className="flex items-center gap-4 text-sm text-gray-400">
                                <span>ì‘ì„±ì¼: {review.createdAt?.toDate?.()?.toLocaleDateString()}</span>
                                {review.updatedAt && (
                                  <span>ìˆ˜ì •ì¼: {review.updatedAt?.toDate?.()?.toLocaleDateString()}</span>
                                )}
                              </div>
                            </div>

                            {canEditReview(review) && (
                              <button
                                onClick={() => handleEditReview(review)}
                                className="ml-4 px-3 py-1.5 bg-[#F59E0B]/20 hover:bg-[#F59E0B]/30 text-[#F59E0B] rounded-lg text-sm font-medium transition-colors"
                              >
                                âœï¸ ìˆ˜ì •
                              </button>
                            )}
                          </div>
                        </div>
                      )}
                    </div>
                  ))}

                  {/* í•˜ë‹¨ ì•¡ì…˜ ë²„íŠ¼ */}
                  <div className="mt-8 pt-6 border-t border-[#333]">
                    <div className="flex gap-4 justify-center">
                      <button
                        onClick={handleGoToProducts}
                        className="bg-gradient-to-r from-[#F59E0B] to-[#D97706] hover:from-[#D97706] hover:to-[#B45309] text-white px-8 py-3 rounded-xl font-medium transition-all transform hover:scale-105 shadow-lg"
                      >
                        ğŸ” ìƒí’ˆ ë‹¤ì‹œ ë‘˜ëŸ¬ë³´ê¸°
                      </button>
                      <button
                        onClick={() => setLocation('/reviews')}
                        className="bg-gradient-to-r from-[#A78BFA] to-[#EC4899] hover:from-[#9333EA] hover:to-[#DB2777] text-white px-8 py-3 rounded-xl font-medium transition-all transform hover:scale-105 shadow-lg"
                      >
                        ğŸ“ ë¦¬ë·° í˜ì´ì§€ ë³´ê¸°
                      </button>
                    </div>
                  </div>
                </div>
              )}
                </>
              )}
            </>
          )}

          {/* ë³´ìœ  ì¿ í° íƒ­ */}
          {activeTab === 'coupons' && (
            <>
                  {coupons.filter(c => !c.isUsed).length === 0 ? (
                    <div className="text-center py-8">
                      <Gift className="w-16 h-16 text-gray-600 mx-auto mb-4" />
                      <h3 className="text-xl font-semibold text-white mb-2">ì‚¬ìš© ê°€ëŠ¥í•œ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                      <p className="text-gray-400 mb-6">
                        ì´ë²¤íŠ¸ë‚˜ êµ¬ë§¤ë¥¼ í†µí•´ ì¿ í°ì„ ë°›ì•„ë³´ì„¸ìš”!<br />
                        í• ì¸ í˜œíƒì„ ë†“ì¹˜ì§€ ë§ˆì„¸ìš”.
                      </p>
                      <button
                        onClick={handleGoToProducts}
                        className="bg-[#10B981] hover:bg-[#059669] text-white px-6 py-3 rounded-lg font-medium transition-colors"
                      >
                        ìƒí’ˆ ë‘˜ëŸ¬ë³´ê¸°
                      </button>
                    </div>
                  ) : (
                    <div className="space-y-4">
                      <h3 className="text-lg font-semibold text-white mb-4">ë³´ìœ  ì¿ í° ({coupons.filter(c => !c.isUsed).length}ì¥)</h3>
                      {coupons.filter(c => !c.isUsed).map(coupon => (
                        <div key={coupon.id} className="bg-[#0A0A0A] border border-[#333] rounded-lg p-4 hover:border-[#10B981] transition-colors">
                          <div className="flex items-center justify-between">
                            <div className="flex items-center gap-4">
                              <div className="p-3 bg-[#10B981]/20 rounded-lg">
                                <Gift className="w-6 h-6 text-[#10B981]" />
                              </div>
                              <div>
                                <h4 className="font-semibold text-white">{coupon.title}</h4>
                                <p className="text-gray-400 text-sm">
                                  ìœ íš¨ê¸°ê°„: {coupon.expiryDate?.toDate?.()?.toLocaleDateString()}
                                </p>
                              </div>
                            </div>
                            <div className="text-right">
                              <p className="font-bold text-[#10B981] text-xl">{coupon.discount}% í• ì¸</p>
                              <button className="text-xs text-gray-400 hover:text-white transition-colors">
                                ì‚¬ìš©í•˜ê¸°
                              </button>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
            </>
          )}
        </div>
      )}
    </div>
  );
};

export default ActivitySection;


